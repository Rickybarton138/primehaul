<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#0b0b0c" id="themeColor"/>
  <title>Email Activity ‚Äî {{ company.company_name }}</title>
  <link rel="stylesheet" href="/static/app.css?v=7"/>
  <script>
    (function(){
      var stored = localStorage.getItem('ph-admin-theme');
      if(stored === 'light') document.documentElement.classList.add('light-mode');
    })();
  </script>
  <style>
    .email-stats{display:flex;gap:12px;margin-bottom:20px;}
    .stat-card{flex:1;padding:16px;border-radius:10px;text-align:center;border:1px solid var(--hair);}
    .stat-card .num{font-size:28px;font-weight:800;margin-bottom:2px;}
    .stat-card .label{font-size:12px;color:var(--muted);}
    .filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
    .filter-bar select{padding:8px 12px;background:rgba(0,0,0,.3);border:1px solid var(--hair);border-radius:6px;color:var(--text);font-size:13px;font-family:inherit;}
    .email-table{width:100%;border-collapse:collapse;font-size:13px;}
    .email-table th{text-align:left;padding:10px 8px;border-bottom:2px solid var(--hair);font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);}
    .email-table td{padding:10px 8px;border-bottom:1px solid var(--hair);vertical-align:top;}
    .email-table tr:hover{background:rgba(255,255,255,.02);}
    .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
    .badge-sent{background:rgba(46,229,157,.15);color:#2ee59d;}
    .badge-failed{background:rgba(255,77,79,.15);color:#ff4d4f;}
    .badge-skipped{background:rgba(255,193,7,.15);color:#ffc107;}
    .badge-queued{background:rgba(96,165,250,.15);color:#60a5fa;}
    .type-badge{background:rgba(96,165,250,.12);color:#60a5fa;}
    .connection-banner{padding:14px 16px;border-radius:8px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:14px;}
    .connection-connected{background:rgba(46,229,157,.08);border:1px solid rgba(46,229,157,.25);color:#2ee59d;}
    .connection-not{background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.25);color:#ffc107;}
    .compose-card{padding:20px;border-radius:10px;border:1px solid var(--hair);background:rgba(255,255,255,.02);margin-top:20px;}
    .compose-card input,.compose-card textarea{width:100%;padding:10px 12px;background:rgba(0,0,0,.3);border:1px solid var(--hair);border-radius:6px;color:var(--text);font-size:14px;font-family:inherit;box-sizing:border-box;margin-bottom:10px;}
    .compose-card textarea{min-height:120px;resize:vertical;}
    .compose-card .send-btn{padding:12px 24px;background:#2ee59d;color:#000;border:none;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;transition:all 150ms;}
    .compose-card .send-btn:hover{background:#25d58d;transform:scale(1.02);}
    .empty-log{text-align:center;padding:40px 20px;color:var(--muted);}
    .empty-log .icon{font-size:40px;margin-bottom:12px;opacity:.4;}
    .truncate{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    @media(max-width:600px){
      .email-stats{flex-direction:column;}
      .email-table{font-size:12px;}
      .email-table th:nth-child(3),.email-table td:nth-child(3){display:none;}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav">
      <div class="nav-inner">
        <a href="/{{ company_slug }}/admin/dashboard" style="font-size:20px;text-decoration:none;">‚Üê</a>
        <div class="nav-center">
          <div>{{ company.company_name }}</div>
          <div style="font-size:12px;color:var(--muted);font-weight:400;">Email Activity</div>
        </div>
        <div></div>
      </div>
    </div>

    <div class="screen">

      <!-- Connection Status Banner -->
      {% if smtp_connected %}
      <div class="connection-banner connection-connected">
        <span style="font-size:18px;">üü¢</span>
        <div>
          <strong>Company email connected</strong>
          <div style="font-size:12px;opacity:.8;">Sending from {{ smtp_from_email }}</div>
        </div>
      </div>
      {% else %}
      <div class="connection-banner connection-not">
        <span style="font-size:18px;">üü°</span>
        <div style="flex:1;">
          <strong>Company email not connected</strong>
          <div style="font-size:12px;opacity:.8;">Emails will send via PrimeHaul. Connect your own email for branded sending.</div>
        </div>
        <a href="/{{ company_slug }}/admin/company-details" style="padding:6px 14px;background:rgba(255,193,7,.2);border:1px solid rgba(255,193,7,.3);border-radius:6px;color:#ffc107;text-decoration:none;font-size:12px;font-weight:600;white-space:nowrap;">
          Set Up
        </a>
      </div>
      {% endif %}

      <!-- Stats -->
      <div class="email-stats">
        <div class="stat-card">
          <div class="num" style="color:#60a5fa;">{{ total_sent }}</div>
          <div class="label">Total Sent</div>
        </div>
        <div class="stat-card">
          <div class="num" style="color:#2ee59d;">{{ sent_today }}</div>
          <div class="label">Sent Today</div>
        </div>
        <div class="stat-card">
          <div class="num" style="color:#ff4d4f;">{{ total_failed }}</div>
          <div class="label">Failed</div>
        </div>
      </div>

      <!-- Filter Bar -->
      <form method="get" action="/{{ company_slug }}/admin/email" class="filter-bar">
        <select name="type">
          <option value="">All Types</option>
          <option value="survey_invitation" {{ 'selected' if filter_type == 'survey_invitation' }}>Survey Invitation</option>
          <option value="quote_approved" {{ 'selected' if filter_type == 'quote_approved' }}>Quote Approved</option>
          <option value="welcome" {{ 'selected' if filter_type == 'welcome' }}>Welcome</option>
          <option value="trial_reminder" {{ 'selected' if filter_type == 'trial_reminder' }}>Trial Reminder</option>
          <option value="marketplace_job" {{ 'selected' if filter_type == 'marketplace_job' }}>Marketplace Job</option>
          <option value="marketplace_bid" {{ 'selected' if filter_type == 'marketplace_bid' }}>Marketplace Bid</option>
          <option value="marketplace_awarded" {{ 'selected' if filter_type == 'marketplace_awarded' }}>Marketplace Awarded</option>
          <option value="manual" {{ 'selected' if filter_type == 'manual' }}>Manual</option>
          <option value="sequence_quote-follow-up" {{ 'selected' if filter_type == 'sequence_quote-follow-up' }}>Quote Follow-Up</option>
          <option value="sequence_survey-nudge" {{ 'selected' if filter_type == 'sequence_survey-nudge' }}>Survey Nudge</option>
          <option value="sequence_onboarding-drip" {{ 'selected' if filter_type == 'sequence_onboarding-drip' }}>Onboarding</option>
          <option value="sequence_post-move-review" {{ 'selected' if filter_type == 'sequence_post-move-review' }}>Review Request</option>
        </select>
        <select name="status">
          <option value="">All Statuses</option>
          <option value="sent" {{ 'selected' if filter_status == 'sent' }}>Sent</option>
          <option value="failed" {{ 'selected' if filter_status == 'failed' }}>Failed</option>
          <option value="skipped" {{ 'selected' if filter_status == 'skipped' }}>Skipped</option>
        </select>
        <button type="submit" class="chip" style="background:rgba(96,165,250,.2);border-color:rgba(96,165,250,.3);cursor:pointer;font-family:inherit;font-size:13px;">
          Filter
        </button>
        {% if filter_type or filter_status %}
        <a href="/{{ company_slug }}/admin/email" class="chip" style="text-decoration:none;opacity:.6;">Clear</a>
        {% endif %}
      </form>

      <!-- Email Log Table -->
      <div class="group">
        <div class="rowhead">
          <div class="rowtitle">Email Log</div>
          <div class="rowsub">{{ logs|length }} {% if logs|length == 200 %}(latest 200){% endif %}</div>
        </div>

        {% if logs|length > 0 %}
        <div style="overflow-x:auto;">
          <table class="email-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Recipient</th>
                <th>Subject</th>
                <th>Type</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td style="white-space:nowrap;color:var(--muted);font-size:12px;">
                  {{ log.sent_at.strftime('%d %b %H:%M') if log.sent_at else '‚Äî' }}
                </td>
                <td>{{ log.to_email }}</td>
                <td class="truncate" title="{{ log.subject }}">{{ log.subject }}</td>
                <td><span class="badge type-badge">{{ log.email_type|replace('_',' ')|title }}</span></td>
                <td>
                  {% if log.status == 'sent' %}
                    <span class="badge badge-sent">Sent</span>
                  {% elif log.status == 'failed' %}
                    <span class="badge badge-failed" title="{{ log.error_message or '' }}">Failed</span>
                  {% else %}
                    <span class="badge badge-skipped">Skipped</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-log">
          <div class="icon">‚úâÔ∏è</div>
          <div style="font-weight:600;margin-bottom:4px;">No emails yet</div>
          <div style="font-size:13px;">Emails sent to customers and from the platform will appear here.</div>
        </div>
        {% endif %}
      </div>

      <!-- Compose Card -->
      <div class="compose-card">
        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">Compose Email</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:16px;">
          {% if smtp_connected %}
            Sending from: <strong style="color:#2ee59d;">{{ smtp_from_email }}</strong>
          {% else %}
            Sending via PrimeHaul ‚Äî
            <a href="/{{ company_slug }}/admin/company-details" style="color:#60a5fa;">configure your email</a> in Company Details to send from your own address
          {% endif %}
        </div>
        <form method="post" action="/{{ company_slug }}/admin/email/send">
          <input type="email" name="to_email" placeholder="Recipient email address" required/>
          <input type="text" name="subject" placeholder="Subject" required maxlength="500"/>
          <textarea name="body" placeholder="Email body (plain text ‚Äî will be wrapped in a clean template)" required></textarea>
          <div style="display:flex;justify-content:flex-end;">
            <button type="submit" class="send-btn">Send Email</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <script>
    // Theme toggle (matches dashboard)
    (function(){
      var theme = localStorage.getItem('ph-admin-theme') || 'dark';
      if(theme === 'light'){
        document.documentElement.classList.add('light-mode');
        document.body.classList.add('light-mode');
      }
    })();
  </script>
</body>
</html>
