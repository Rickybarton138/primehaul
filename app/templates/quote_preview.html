{% extends "base.html" %}

{% block content %}
  <!-- Voice guidance for this page -->
  {% if job.status == 'approved' %}
  <div id="voiceGuidance" data-message="Brilliant news! Your quote's been approved and you can see the final price on screen. When you're ready to book your move, just tap Accept This Quote at the bottom and we'll get everything sorted for you." hidden></div>
  {% elif job.status == 'awaiting_approval' %}
  <div id="voiceGuidance" data-message="Your quote's been submitted and our team is having a look. We'll ping you a text as soon as it's ready. Feel free to close this page — we'll send you the link when it's approved." hidden></div>
  {% else %}
  <div id="voiceGuidance" data-message="Here's your quote! You can see all the items we detected and the estimated price range. Have a look through the summary. If it looks good, tap Submit for Review at the bottom. Our team will check it over and get back to you, usually within a couple of hours." hidden></div>
  {% endif %}

  {% if job.status == 'approved' %}
    <div class="largetitle">Quote approved</div>
    <p class="subtitle">Your quote is ready to book. Secure your moving date now.</p>
  {% elif job.status == 'awaiting_approval' %}
    <div class="largetitle">Quote submitted</div>
    <p class="subtitle">Our team is reviewing your quote. We'll notify you when it's approved.</p>
  {% else %}
    <div class="largetitle">Your quote</div>
    <p class="subtitle">AI-powered estimate. Submit for review when ready.</p>
  {% endif %}

  <div class="group">
    {% if job.status == 'approved' and job.final_quote_price %}
      <!-- Show final fixed price for approved quotes -->
      <div class="bigprice" style="color:var(--success);">£{{ job.final_quote_price }}</div>
      <div class="pill" style="background:rgba(46,229,157,.15); color:#2ee59d; border-color:rgba(46,229,157,.3);">✓ Final Quote</div>
    {% elif job.status == 'approved' %}
      <!-- Fallback for approved without final price (legacy) -->
      <div class="bigprice">£{{ estimate_low }} – £{{ estimate_high }}</div>
      <div class="pill" style="background:rgba(46,229,157,.15); color:#2ee59d; border-color:rgba(46,229,157,.3);">✓ Approved</div>
    {% elif job.status == 'awaiting_approval' %}
      <div class="bigprice">£{{ estimate_low }} – £{{ estimate_high }}</div>
      <div class="pill" style="background:rgba(96,165,250,.15); color:#60a5fa; border-color:rgba(96,165,250,.3);">⏳ Pending Review</div>
    {% else %}
      <div class="bigprice">£{{ estimate_low }} – £{{ estimate_high }}</div>
      <div class="pill">{{ confidence }}</div>
    {% endif %}

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Move summary</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Items detected</span>
            <span class="statrow-value">{{ total_items }}</span>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Collection</span>
            <span class="statrow-value">{{ job.property_type|title|replace('_', ' ') if job.property_type else 'Not specified' }}</span>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <div class="statrow-text">
            <span class="statrow-label">Delivery</span>
            <span class="statrow-value">{{ job.dropoff_property_type|title|replace('_', ' ') if job.dropoff_property_type else 'Not specified' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="font-weight:700; margin-bottom:12px;">Route details{% if distance_miles > 0 %} <span style="font-weight:400; color:var(--muted);">({{ "%.0f"|format(distance_miles) }} miles)</span>{% endif %}</div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Pickup</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.pickup.label if job.pickup else "Not set" }}</div>
          </div>
        </div>
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Delivery</div>
            <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.dropoff.label if job.dropoff else "Not set" }}</div>
          </div>
        </div>
        {% if job.move_date %}
        <div class="statrow">
          <div class="staticon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Move date</div>
            <div style="font-size:14px; font-weight:600;">{{ job.move_date.strftime('%A, %d %B %Y') }}</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    {% if packing_breakdown and (packing_breakdown.small_boxes.qty > 0 or packing_breakdown.medium_boxes.qty > 0 or packing_breakdown.large_boxes.qty > 0 or packing_breakdown.robe_cartons.qty > 0) %}
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <div style="font-weight:700;">Packing materials</div>
        <a href="/s/{{ company_slug }}/{{ token }}/packing-services" style="font-size:13px; color:var(--success); text-decoration:none; font-weight:600;">Change</a>
      </div>

      <div style="padding:12px 14px; border-radius:10px; background:var(--subtle-bg); border:1px solid var(--subtle-border); font-size:14px;">
        {% if job.customer_provides_packing %}
          <div style="display:flex; align-items:center; gap:8px;">
            <span>You'll provide your own materials</span>
            <span style="font-weight:600; color:var(--muted);">Free</span>
          </div>
        {% else %}
          <div style="display:flex; align-items:center; gap:8px;">
            <span>Our packing materials included</span>
            <span style="font-weight:600; margin-left:auto;">+£{{ "%.2f"|format(breakdown.packing) }}</span>
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% if packing_service_breakdown and packing_service_breakdown.rooms %}
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <div style="font-weight:700;">Professional packing</div>
        <a href="/s/{{ company_slug }}/{{ token }}/packing-services" style="font-size:13px; color:var(--success); text-decoration:none; font-weight:600;">Change</a>
      </div>

      {% set selected_rooms = packing_service_breakdown.rooms | selectattr('is_selected') | list %}
      {% if selected_rooms %}
        <div style="display:flex; flex-direction:column; gap:6px;">
          {% for room in selected_rooms %}
          <div style="padding:10px 14px; border-radius:10px; background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.2); font-size:14px; display:flex; align-items:center; justify-content:space-between;">
            <span>{{ room.room_name }} ({{ room.items_count }} items)</span>
            <span style="font-weight:600; color:var(--success);">+£{{ "%.0f"|format(room.cost) }}</span>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="padding:10px 14px; border-radius:10px; background:var(--subtle-bg); border:1px solid var(--subtle-border); font-size:14px; color:var(--muted);">
          No rooms selected for professional packing
        </div>
      {% endif %}
    </div>
    {% endif %}

    {% if company.tcs_document_url %}
    <div style="margin-top:16px; padding:12px 16px; border-radius:10px; background:var(--subtle-bg); border:1px solid var(--subtle-border); display:flex; align-items:center; justify-content:space-between;">
      <span style="font-size:13px; color:var(--muted);">Terms & Conditions</span>
      <a href="/s/{{ company_slug }}/{{ token }}/tcs/view" target="_blank" style="padding:8px 14px; background:var(--subtle-bg-strong); border-radius:6px; text-decoration:none; color:var(--text); font-weight:600; font-size:13px;">
        View →
      </a>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block footer %}
  <div class="footer footer-clean">
    <div class="footer-inner">
      {% if job.status == 'approved' %}
        <a href="/s/{{ company_slug }}/{{ token }}/quote/accept" class="btn" style="text-decoration:none; display:block;">
          Accept This Quote
        </a>
        <div class="microhint" style="text-align:center; margin-top:8px;">
          Quote approved • Accept to continue with booking
        </div>
      {% elif job.status == 'in_progress' %}
        <form method="post" action="/s/{{ company_slug }}/{{ token }}/submit-quote">
          <button class="btn" type="submit">Submit for review</button>
          <div class="microhint" style="text-align:center; margin-top:8px;">
            Usually confirmed within 2 hours
          </div>
        </form>
      {% elif job.status == 'awaiting_approval' %}
        <div style="text-align:center;">
          <div class="btn" style="opacity:.7; pointer-events:none; background:rgba(96,165,250,.3); color:#60a5fa; border:1px solid rgba(96,165,250,.5);">
            ⏳ Awaiting approval
          </div>
          <div class="microhint" style="margin-top:8px;">
            We're reviewing your quote. You'll receive a text when it's ready!
          </div>
        </div>
      {% endif %}
      <a href="/s/{{ company_slug }}/{{ token }}/photos/bulk" class="btn secondary" style="margin-top:10px;">
        ← Upload More Photos
      </a>
    </div>
  </div>
{% endblock %}
