<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover, user-scalable=yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0b0b0c" id="themeColor" />
    <meta name="apple-mobile-web-app-title" content="primehaul" />

    <title>{{ title or "primehaul" }}</title>
    <link rel="stylesheet" href="/static/app.css?v=7" />
    <script>
      // Apply theme immediately to prevent flash
      (function(){
        var stored = localStorage.getItem('ph-theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        if(theme === 'light') {
          document.documentElement.classList.add('light-mode');
          document.body && document.body.classList.add('light-mode');
        }
      })();
    </script>
  </head>

  <body>
    <div class="app">
      <header class="nav">
        <div class="nav-inner">
          {% if back_url %}
            <a class="nav-back" href="{{ back_url }}" aria-label="Back">‚Äπ Back</a>
          {% else %}
            <span class="nav-back ghost" aria-hidden="true">‚Äπ Back</span>
          {% endif %}

          <div class="nav-center">
            {{ nav_title if nav_title else "primehaul" }}
          </div>

          <button class="theme-toggle" id="themeToggle" aria-label="Toggle light/dark mode" title="Toggle theme">
            <span class="theme-icon">üåô</span>
          </button>
        </div>

        {% if progress is not none %}
          <div class="nav-progress" aria-label="Progress">
            <div class="nav-progress-inner">
              <div class="nav-progress-bar" data-progress="{{ progress|default(0) }}"></div>
            </div>
          </div>
        {% endif %}
      </header>

      <main class="screen" role="main">
        {% block content %}{% endblock %}
      </main>

      {% block footer %}{% endblock %}
    </div>

    <script>
      (function () {
        // Prevent accidental double submits on mobile
        document.addEventListener(
          "submit",
          function (e) {
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) {
              btn.disabled = true;
              btn.classList.add("is-busy");
            }
          },
          true
        );

        // Progress bar width (avoid inline style with Jinja)
        const bar = document.querySelector(".nav-progress-bar[data-progress]");
        if (bar) {
          const p = Number(bar.getAttribute("data-progress") || "0");
          const clamped = Math.max(0, Math.min(100, p));
          bar.style.width = clamped + "%";
        }

        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle ? themeToggle.querySelector('.theme-icon') : null;
        const themeColor = document.getElementById('themeColor');

        function getStoredTheme() {
          return localStorage.getItem('ph-theme');
        }

        function getSystemTheme() {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function getCurrentTheme() {
          return getStoredTheme() || getSystemTheme();
        }

        function applyTheme(theme) {
          if (theme === 'light') {
            document.documentElement.classList.add('light-mode');
            document.body.classList.add('light-mode');
            if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            if (themeColor) themeColor.setAttribute('content', '#f5f5f7');
          } else {
            document.documentElement.classList.remove('light-mode');
            document.body.classList.remove('light-mode');
            if (themeIcon) themeIcon.textContent = 'üåô';
            if (themeColor) themeColor.setAttribute('content', '#0b0b0c');
          }
        }

        function toggleTheme() {
          const current = getCurrentTheme();
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('ph-theme', next);
          applyTheme(next);
        }

        // Initialize theme
        applyTheme(getCurrentTheme());

        // Toggle button click
        if (themeToggle) {
          themeToggle.addEventListener('click', toggleTheme);
        }

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          if (!getStoredTheme()) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      })();
    </script>
  </body>
</html>
