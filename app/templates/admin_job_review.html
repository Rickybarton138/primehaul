<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/app.css"/>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav">
      <div class="nav-inner">
        <a href="/admin/dashboard" class="nav-back">‚Üê Dashboard</a>
        <div class="nav-center">Job #{{ token[:8] }}</div>
        <div></div>
      </div>
    </div>

    <div class="screen">
      <div class="largetitle">
        {% if job.status == 'awaiting_approval' %}
          ‚è≥ Review Quote
        {% elif job.status == 'approved' %}
          ‚úÖ Approved Quote
        {% elif job.status == 'rejected' %}
          ‚ùå Rejected Quote
        {% else %}
          üìã Quote Details
        {% endif %}
      </div>
      <p class="subtitle">Job #{{ token }}</p>

      <!-- Status Banner -->
      {% if job.status == 'awaiting_approval' %}
        <div class="group" style="background:rgba(255,165,0,.15); border-color:rgba(255,165,0,.3);">
          <div style="color:#ffa500; font-weight:700; text-align:center; font-size:16px;">
            ‚è≥ Awaiting Your Approval
          </div>
        </div>
      {% elif job.status == 'approved' %}
        <div class="group" style="background:rgba(46,229,157,.15); border-color:rgba(46,229,157,.3);">
          <div style="color:#2ee59d; font-weight:700; text-align:center; font-size:16px;">
            ‚úÖ Quote Approved
          </div>
        </div>
      {% elif job.status == 'rejected' %}
        <div class="group" style="background:rgba(255,77,79,.15); border-color:rgba(255,77,79,.3);">
          <div style="color:#ff4d4f; font-weight:700; text-align:center; font-size:16px;">
            ‚ùå Quote Rejected
          </div>
          {% if job.get('rejection_reason') %}
            <div style="margin-top:8px; font-size:14px; color:var(--muted); text-align:center;">
              Reason: {{ job.rejection_reason }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <!-- Quote Summary -->
      <div class="group">
        <div class="bigprice">¬£{{ quote.estimate_low }} ‚Äì ¬£{{ quote.estimate_high }}</div>
        <div class="pill">{{ quote.confidence }}</div>

        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">Move Summary</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="statrow">
              <div class="staticon">üì¶</div>
              <div class="statrow-text">
                <span class="statrow-label">Total items</span>
                <span class="statrow-value">{{ quote.total_items }}</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">üìê</div>
              <div class="statrow-text">
                <span class="statrow-label">Volume (CBM)</span>
                <span class="statrow-value">{{ quote.total_cbm }} m¬≥</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">‚öñÔ∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Est. weight</span>
                <span class="statrow-value">{{ quote.total_weight_kg }} kg</span>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon">üèãÔ∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Bulky items</span>
                <span class="statrow-value">{{ quote.bulky_items }}</span>
              </div>
            </div>
            {% if quote.fragile_items > 0 %}
            <div class="statrow">
              <div class="staticon">‚ö†Ô∏è</div>
              <div class="statrow-text">
                <span class="statrow-label">Fragile items</span>
                <span class="statrow-value">{{ quote.fragile_items }}</span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Pricing Breakdown -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">üí∞ Pricing Breakdown</div>
          <div style="display:flex; flex-direction:column; gap:8px; font-size:14px;">
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Base callout:</span>
              <strong>¬£{{ quote.breakdown.base }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Volume ({{ quote.total_cbm }} m¬≥ √ó ¬£35):</span>
              <strong>¬£{{ "%.2f"|format(quote.breakdown.volume) }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Bulky surcharge:</span>
              <strong>¬£{{ quote.breakdown.bulky }}</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Fragile surcharge:</span>
              <strong>¬£{{ quote.breakdown.fragile }}</strong>
            </div>
            {% if quote.breakdown.weight > 0 %}
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Weight surcharge:</span>
              <strong>¬£{{ "%.2f"|format(quote.breakdown.weight) }}</strong>
            </div>
            {% endif %}
            <div style="display:flex; justify-content:space-between;">
              <span style="color:var(--muted);">Distance:</span>
              <strong>¬£{{ quote.breakdown.distance }}</strong>
            </div>
          </div>
        </div>

        <!-- Route -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:12px;">Route</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="statrow">
              <div class="staticon" style="background:rgba(46,229,157,.15);">
                <span style="font-size:12px;">üìç</span>
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Pickup</div>
                <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.pickup.label if job.pickup else "Not set" }}</div>
              </div>
            </div>
            <div class="statrow">
              <div class="staticon" style="background:rgba(255,77,79,.15);">
                <span style="font-size:12px;">üìç</span>
              </div>
              <div style="flex:1; min-width:0;">
                <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; margin-bottom:3px;">Delivery</div>
                <div style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ job.dropoff.label if job.dropoff else "Not set" }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Property Type -->
        {% if job.property_type %}
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--hair);">
          <div style="font-weight:700; margin-bottom:8px;">Property Type</div>
          <div style="font-size:15px;">{{ job.property_type }}</div>
        </div>
        {% endif %}
      </div>

      <!-- Rooms & Items -->
      {% if job.rooms and job.rooms|length > 0 %}
        <div class="group">
          <div class="rowhead">
            <div class="rowtitle">üì¶ Inventory</div>
            <div class="rowsub">{{ job.rooms|length }} rooms</div>
          </div>

          <div class="invlist">
            {% for room in job.rooms %}
              <div style="padding:14px; border-radius:14px; border:1px solid var(--hair); background:rgba(255,255,255,.02); margin-bottom:10px;">
                <div style="font-weight:700; margin-bottom:8px;">{{ room.name }}</div>

                {% if room.photos and room.photos|length > 0 %}
                  <div class="photogrid" style="margin-bottom:12px;">
                    {% for photo in room.photos[:6] %}
                      <div class="photo"><img class="photoimg" src="{{ photo.url }}" alt="Photo" loading="lazy" /></div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if room.items and room.items|length > 0 %}
                  <div style="font-size:13px; color:var(--muted); margin-bottom:6px;">{{ room.items|length }} items detected:</div>
                  <div class="itemslist">
                    {% for item in room.items %}
                      <div class="itemrow">
                        <div class="iteminfo">
                          <div class="itemname">{{ item.qty }}x {{ item.name }}</div>
                          {% if item.notes %}
                            <div class="itemnotes">{{ item.notes }}</div>
                          {% endif %}
                          <div class="itemnotes">
                            {{ item.length_cm }}√ó{{ item.width_cm }}√ó{{ item.height_cm }}cm
                            ‚Ä¢ {{ item.weight_kg }}kg
                            ‚Ä¢ {{ item.cbm }} m¬≥
                          </div>
                        </div>
                        {% if item.bulky %}
                          <span class="badge">Bulky</span>
                        {% endif %}
                        {% if item.fragile %}
                          <span class="badge" style="background:rgba(255,165,0,.15); color:#ffa500;">Fragile</span>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div style="font-size:13px; color:var(--muted);">No items detected yet</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Action Buttons (only if awaiting approval) -->
    {% if job.status == 'awaiting_approval' %}
      <div class="footer footer-clean">
        <div class="footer-inner">
          <form method="post" action="/admin/job/{{ token }}/approve">
            <button class="btn" type="submit" style="background:#2ee59d; color:#000;">
              ‚úÖ Approve Quote
            </button>
          </form>

          <button class="btn secondary" type="button" id="rejectBtn" style="margin-top:10px;">
            ‚ùå Reject Quote
          </button>
        </div>
      </div>

      <!-- Reject Modal -->
      <div id="rejectModal" class="overlay" style="display:none;">
        <div class="modal">
          <div class="modal-title">Reject Quote</div>
          <form method="post" action="/admin/job/{{ token }}/reject">
            <div style="margin:12px 0;">
              <label for="reason" style="display:block; font-weight:600; margin-bottom:8px; font-size:14px;">
                Reason (optional)
              </label>
              <textarea
                id="reason"
                name="reason"
                rows="3"
                placeholder="e.g., Need clearer photos of heavy items"
                style="
                  width:100%;
                  padding:12px;
                  border-radius:12px;
                  border:1px solid var(--hair);
                  background:rgba(255,255,255,.04);
                  color:var(--text);
                  font-size:14px;
                  font-family:inherit;
                  resize:vertical;
                "
              ></textarea>
            </div>

            <button class="btn" type="submit" style="background:#ff4d4f; color:#fff;">
              Confirm Rejection
            </button>
            <button class="btn secondary" type="button" id="cancelBtn" style="margin-top:10px;">
              Cancel
            </button>
          </form>
        </div>
      </div>

      <script>
        (function() {
          const rejectBtn = document.getElementById('rejectBtn');
          const modal = document.getElementById('rejectModal');
          const cancelBtn = document.getElementById('cancelBtn');

          rejectBtn.addEventListener('click', function() {
            modal.style.display = 'flex';
          });

          cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
          });

          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.style.display = 'none';
            }
          });
        })();
      </script>
    {% else %}
      <div class="footer footer-clean">
        <div class="footer-inner">
          <a href="/admin/dashboard" class="btn secondary">
            ‚Üê Back to Dashboard
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</body>
</html>
