<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/static/app.css"/>
  <style>
    .quick-approve-btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:#2ee59d;
      color:#000;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:all 150ms;
    }
    .quick-approve-btn:hover{
      background:#25d58d;
      transform:scale(1.05);
    }
    .quick-approve-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .urgency-badge{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .urgency-high{
      background:rgba(255,77,79,.2);
      color:#ff4d4f;
      animation:pulseUrgent 2s ease-in-out infinite;
    }
    .urgency-medium{
      background:rgba(96,165,250,.2);
      color:#60a5fa;
    }
    .urgency-low{
      background:rgba(46,229,157,.2);
      color:#2ee59d;
    }
    @keyframes pulseUrgent{
      0%, 100%{ opacity:1; }
      50%{ opacity:.6; }
    }
    .revenue-card{
      background:linear-gradient(135deg, rgba(46,229,157,.15), rgba(46,229,157,.05));
      border:2px solid rgba(46,229,157,.3);
    }
    .customer-info{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .photo-count{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      padding:3px 8px;
      border-radius:6px;
      background:rgba(255,255,255,.05);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <div class="nav">
      <div class="nav-inner">
        <div style="font-size:20px;">üëî</div>
        <div class="nav-center">Boss Dashboard</div>
        <form method="post" action="/auth/logout" style="margin:0;">
          <button type="submit" style="background:none; border:none; color:var(--text); text-decoration:none; font-size:14px; opacity:.8; cursor:pointer; font-family:inherit;">Logout</button>
        </form>
      </div>
    </div>

    <!-- Quick Links -->
    <div style="padding:12px 16px; background:rgba(255,255,255,.02); border-bottom:1px solid var(--hair); overflow-x:auto;">
      <div style="display:flex; gap:8px; min-width:max-content;">
        <a href="/{{ company_slug }}/admin/dashboard" class="chip" style="background:rgba(46,229,157,.2); border-color:rgba(46,229,157,.3); text-decoration:none;">
          üìä Dashboard
        </a>
        <a href="/{{ company_slug }}/admin/analytics" class="chip" style="text-decoration:none;">
          üìà Analytics
        </a>
        <a href="/{{ company_slug }}/admin/pricing" class="chip" style="text-decoration:none;">
          üí∞ Pricing
        </a>
        <a href="/{{ company_slug }}/admin/branding" class="chip" style="text-decoration:none;">
          üé® Branding
        </a>
        <a href="/{{ company_slug }}/admin/terms" class="chip" style="text-decoration:none;">
          üìã Terms & Conditions
        </a>
        <a href="/{{ company_slug }}/admin/company-details" class="chip" style="text-decoration:none;">
          üè¢ Company Details
        </a>
        <a href="/{{ company_slug }}/admin/payments" class="chip" style="text-decoration:none;">
          üí≥ Payments
        </a>
        <a href="/{{ company_slug }}/admin/buy-credits" class="chip" style="text-decoration:none;{% if low_credits %} background:rgba(255,77,79,.2); border-color:rgba(255,77,79,.3);{% endif %}">
          üéüÔ∏è Credits{% if not is_partner %}: {{ credits }}{% endif %}{% if low_credits %} ‚ö†Ô∏è{% endif %}
        </a>
      </div>
    </div>

    <!-- Credit Balance Banner -->
    {% if low_credits and not is_partner %}
    <div style="padding:12px 16px; background:rgba(255,77,79,.1); border-bottom:1px solid rgba(255,77,79,.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div style="font-size:14px; color:#ff6b6b;">
          <strong>‚ö†Ô∏è Low on credits!</strong> You have {{ credits }} survey credits remaining.
        </div>
        <a href="/{{ company_slug }}/admin/buy-credits" class="quick-approve-btn" style="background:#ff6b6b; padding:8px 16px;">
          Buy More
        </a>
      </div>
    </div>
    {% endif %}

    <div class="screen">
      {% if show_onboarding %}
      <div class="group" id="onboardingBanner" style="background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.3); position:relative;">
        <button onclick="dismissOnboarding()" style="position:absolute; top:8px; right:8px; background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px;">√ó</button>
        <div style="font-weight:700; margin-bottom:8px;">üëã Welcome!</div>
        <div style="font-size:14px; color:var(--muted); line-height:1.5;">
          <strong style="color:#2ee59d;">1.</strong> Create a survey link below<br>
          <strong style="color:#2ee59d;">2.</strong> Send it to your customer<br>
          <strong style="color:#2ee59d;">3.</strong> They snap photos, you approve
        </div>
      </div>
      {% endif %}

      <!-- Create Survey Link -->
      <div class="group" style="background:rgba(46,229,157,.1); border:1px solid rgba(46,229,157,.3);">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div style="font-weight:700;">New Customer Quote</div>
          <button onclick="generateSurveyLink()" class="quick-approve-btn" style="padding:12px 20px;">
            + Create Link
          </button>
        </div>

        <div id="generatedLinkSection" style="display:none; margin-top:14px; padding-top:14px; border-top:1px solid rgba(46,229,157,.2);">
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" id="surveyLinkInput" readonly style="flex:1; padding:10px 12px; background:rgba(0,0,0,.3); border:1px solid var(--hair); border-radius:6px; color:#fff; font-size:13px; font-family:monospace;">
            <button onclick="copySurveyLink()" id="copyBtn" style="padding:10px 16px; background:#2ee59d; color:#000; border:none; border-radius:6px; font-weight:700; cursor:pointer;">
              Copy
            </button>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <a id="whatsappShare" href="#" target="_blank" style="padding:6px 12px; background:rgba(37,211,102,.15); border-radius:6px; color:#25d366; text-decoration:none; font-size:12px; font-weight:600;">WhatsApp</a>
            <a id="smsShare" href="#" style="padding:6px 12px; background:rgba(255,255,255,.05); border-radius:6px; color:var(--text); text-decoration:none; font-size:12px; font-weight:600;">SMS</a>
            <a id="emailShare" href="#" style="padding:6px 12px; background:rgba(255,255,255,.05); border-radius:6px; color:var(--text); text-decoration:none; font-size:12px; font-weight:600;">Email</a>
          </div>
        </div>
      </div>

      <div class="largetitle">Quotes</div>
      <p class="subtitle"><span id="lastUpdate">Just now</span></p>

      <!-- Revenue -->
      <div style="display:flex; gap:12px; margin-bottom:16px;">
        <div style="flex:1; padding:14px; border-radius:10px; background:rgba(96,165,250,.08); border:1px solid rgba(96,165,250,.2); text-align:center;">
          <div style="font-size:12px; color:#60a5fa; margin-bottom:4px;">Pending</div>
          <div style="font-size:22px; font-weight:800; color:#60a5fa;">¬£<span id="pendingRevenue">0</span></div>
        </div>
        <div style="flex:1; padding:14px; border-radius:10px; background:rgba(46,229,157,.08); border:1px solid rgba(46,229,157,.2); text-align:center;">
          <div style="font-size:12px; color:#2ee59d; margin-bottom:4px;">Approved</div>
          <div style="font-size:22px; font-weight:800; color:#2ee59d;">¬£<span id="approvedRevenue">0</span></div>
        </div>
      </div>

      <!-- Awaiting Approval -->
      <div class="group">
        <div class="rowhead">
          <div class="rowtitle">‚è≥ Awaiting Approval</div>
          <div class="rowsub" id="awaitingCount">{{ awaiting_jobs|length }}</div>
        </div>

        {% if awaiting_jobs|length > 0 %}
          <div class="invlist" id="awaitingList">
            {% for job in awaiting_jobs %}
              <div class="invlink" data-job-id="{{ job.token }}" style="border-color:rgba(96,165,250,.3); background:rgba(96,165,250,.05);">
                <div class="invtop">
                  <div style="flex:1;">
                    <div class="invroom">
                      üÜï <strong>{{ job.customer_name or ('Job #' + job.token[:8]) }}</strong>
                    </div>
                    <div class="customer-info">
                      {% if job.customer_email %}
                        ‚úâÔ∏è {{ job.customer_email }}
                      {% endif %}
                      {% if job.customer_phone %}
                        ‚Ä¢ üì± {{ job.customer_phone }}
                      {% endif %}
                    </div>
                  </div>
                  <div style="text-align:right;">
                    <div class="invmeta" style="color:#60a5fa; font-weight:700; margin-bottom:4px;">Pending</div>
                    <span class="urgency-badge urgency-high" id="urgency-{{ job.token }}">‚ö° URGENT</span>
                  </div>
                </div>
                <div class="invitems" style="margin-top:10px;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <strong style="font-size:18px; color:#60a5fa;">¬£{{ "%.0f"|format((job.custom_price_low or ((job.total_cbm or 0) * 35 + 250))) }}</strong>
                      <span style="color:var(--muted);">
                        ‚Ä¢ {{ job.total_cbm or 0 }} m¬≥
                        ‚Ä¢ {{ job.total_weight_kg or 0 }} kg
                      </span>
                      <span class="photo-count">
                        üì∏ {% set photo_count = 0 %}{% for r in (job.rooms or []) %}{% set photo_count = photo_count + (r.photos|length if r.photos else 0) %}{% endfor %}{{ photo_count }}
                      </span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <button class="quick-approve-btn" onclick="quickApprove('{{ job.token }}', event)">
                        ‚ö° Quick Approve
                      </button>
                      <a href="/{{ company_slug }}/admin/job/{{ job.token }}" class="btn secondary" style="padding:8px 16px; margin:0; font-size:13px;">
                        View Details
                      </a>
                    </div>
                  </div>
                  {% if job.pickup and job.dropoff and job.pickup.label and job.dropoff.label %}
                    <div style="font-size:11px; color:var(--muted); margin-top:8px;">
                      üìç {{ job.pickup.label[:40] }}... ‚Üí {{ job.dropoff.label[:40] }}...
                    </div>
                  {% endif %}
                  {% if job.move_date %}
                    <div style="font-size:11px; color:var(--muted); margin-top:4px;">
                      üìÖ Move date: {{ job.move_date.strftime('%d %b %Y') }}
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty" style="margin-top:12px;">
            <div class="empty-title">All caught up! ‚úÖ</div>
            <div class="empty-sub">No quotes waiting for approval</div>
          </div>
        {% endif %}
      </div>

      <!-- Recently Approved -->
      {% if approved_jobs|length > 0 %}
        <div class="group">
          <div class="rowhead">
            <div class="rowtitle">‚úÖ Recently Approved</div>
            <div class="rowsub">{{ approved_jobs|length }}</div>
          </div>

          <div class="invlist">
            {% for job in approved_jobs %}
              <a class="invlink" href="/{{ company_slug }}/admin/job/{{ job.token }}" style="border-color:rgba(46,229,157,.3); background:rgba(46,229,157,.05);">
                <div class="invtop">
                  <div style="flex:1;">
                    <div class="invroom">
                      ‚úì <strong>{{ job.customer_name or ('Job #' + job.token[:8]) }}</strong>
                    </div>
                    <div class="customer-info">
                      {% if job.customer_email %}‚úâÔ∏è {{ job.customer_email }}{% endif %}
                    </div>
                  </div>
                  <div class="invmeta" style="color:#2ee59d; font-weight:700;">Approved</div>
                </div>
                <div class="invitems">
                  <strong>¬£{{ "%.0f"|format((job.custom_price_low or ((job.total_cbm or 0) * 35 + 250))) }}</strong>
                  ‚Ä¢ {{ job.total_cbm or 0 }} m¬≥
                  ‚Ä¢ {{ job.total_weight_kg or 0 }} kg
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

    </div>

  </div>

  <!-- Sound effect for new quotes -->
  <audio id="notificationSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwPUKXh8LljHAU2kdXyz3orBSJ2xu/gkUELElyx6OyrWBULRp/g8r1qIAUsgs/y2ooiCQ==" type="audio/wav"/>
  </audio>

  <script>
    let lastQuoteCount = {{ awaiting_jobs|length }};
    const notificationSound = document.getElementById('notificationSound');

    // Quick approve function
    async function quickApprove(token, event) {
      event.preventDefault();
      event.stopPropagation();

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Approving...';

      try {
        const response = await fetch(`/{{ company_slug }}/admin/job/${token}/quick-approve`, {
          method: 'POST',
          credentials: 'include'
        });

        if (response.ok) {
          btn.textContent = '‚úÖ Approved!';
          btn.style.background = '#2ee59d';

          // Remove from list after animation
          setTimeout(() => {
            const card = document.querySelector(`[data-job-id="${token}"]`);
            if (card) {
              card.style.transition = 'all 300ms ease';
              card.style.opacity = '0';
              card.style.transform = 'translateX(100px)';
              setTimeout(() => card.remove(), 300);
            }

            // Update counts
            const count = parseInt(document.getElementById('awaitingCount').textContent) - 1;
            document.getElementById('awaitingCount').textContent = count;

            // Reload page after 1 second to refresh all stats
            setTimeout(() => location.reload(), 1000);
          }, 800);
        } else {
          btn.textContent = '‚ùå Failed';
          btn.disabled = false;
          setTimeout(() => {
            btn.textContent = '‚ö° Quick Approve';
          }, 2000);
        }
      } catch (err) {
        btn.textContent = '‚ùå Error';
        btn.disabled = false;
        setTimeout(() => {
          btn.textContent = '‚ö° Quick Approve';
        }, 2000);
      }
    }

    // Calculate urgency and revenue
    function updateStats() {
      // Calculate pending revenue
      let pendingTotal = 0;
      document.querySelectorAll('[data-job-id]').forEach(card => {
        const priceText = card.querySelector('.invitems strong').textContent;
        const price = parseInt(priceText.replace(/[^0-9]/g, ''));
        pendingTotal += price;
      });
      document.getElementById('pendingRevenue').textContent = pendingTotal.toLocaleString();

      // Calculate approved revenue
      let approvedTotal = 0;
      {% for job in approved_jobs %}
        approvedTotal += {{ job.custom_price_low or ((job.total_cbm or 0) * 35 + 250) }};
      {% endfor %}
      document.getElementById('approvedRevenue').textContent = Math.round(approvedTotal).toLocaleString();
    }

    // Auto-refresh with notification
    let refreshInterval = setInterval(async () => {
      try {
        const response = await fetch('/{{ company_slug }}/admin/dashboard');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newCount = parseInt(doc.querySelector('#awaitingCount')?.textContent || 0);

        // Play sound if new quote arrived
        if (newCount > lastQuoteCount) {
          notificationSound.play().catch(() => {});

          // Show notification
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('New Quote Submitted! üí∞', {
              body: `${newCount - lastQuoteCount} new quote(s) awaiting approval`,
              icon: '/static/icon.png',
              tag: 'new-quote'
            });
          }
        }

        lastQuoteCount = newCount;

        // Update timestamp
        document.getElementById('lastUpdate').textContent = 'Just now';
      } catch (err) {
        console.log('Auto-refresh error:', err);
      }
    }, 15000); // Every 15 seconds

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Update stats on load
    updateStats();

    // ========== SURVEY LINK GENERATOR ==========
    function generateSurveyLink() {
      // Generate a random 8-character token
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < 8; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }

      // Build the full URL
      const baseUrl = window.location.origin;
      const surveyUrl = `${baseUrl}/s/{{ company_slug }}/${token}/start-v2`;

      // Show the link section
      document.getElementById('generatedLinkSection').style.display = 'block';
      document.getElementById('surveyLinkInput').value = surveyUrl;

      // Update share links
      const message = encodeURIComponent(`Hi! Please fill out this quick survey for your removal quote: ${surveyUrl}`);
      document.getElementById('whatsappShare').href = `https://wa.me/?text=${message}`;
      document.getElementById('smsShare').href = `sms:?body=${message}`;
      document.getElementById('emailShare').href = `mailto:?subject=Your Removal Quote Survey&body=${message}`;

      // Scroll to show the link
      document.getElementById('generatedLinkSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function copySurveyLink() {
      const input = document.getElementById('surveyLinkInput');
      const btn = document.getElementById('copyBtn');

      // Copy to clipboard
      navigator.clipboard.writeText(input.value).then(() => {
        btn.textContent = '‚úì Copied!';
        btn.style.background = '#25d58d';
        setTimeout(() => {
          btn.textContent = 'üìã Copy';
          btn.style.background = '#2ee59d';
        }, 2000);
      }).catch(() => {
        // Fallback for older browsers
        input.select();
        document.execCommand('copy');
        btn.textContent = '‚úì Copied!';
        setTimeout(() => {
          btn.textContent = 'üìã Copy';
        }, 2000);
      });
    }

    // ========== ONBOARDING ==========
    function dismissOnboarding() {
      const banner = document.getElementById('onboardingBanner');
      if (banner) {
        banner.style.transition = 'all 300ms ease';
        banner.style.opacity = '0';
        banner.style.transform = 'translateY(-20px)';
        setTimeout(() => banner.remove(), 300);

        // Remember dismissal in localStorage
        localStorage.setItem('primehaul_onboarding_dismissed', 'true');

        // Also tell the server (fire and forget)
        fetch('/{{ company_slug }}/admin/dismiss-onboarding', { method: 'POST' }).catch(() => {});
      }
    }

    // Check if onboarding was already dismissed locally
    if (localStorage.getItem('primehaul_onboarding_dismissed') === 'true') {
      const banner = document.getElementById('onboardingBanner');
      if (banner) banner.remove();
    }
  </script>
</body>
</html>
